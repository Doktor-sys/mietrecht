name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ps-lint:
    name: PowerShell lint + checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: actions/setup-pwsh@v2
        with:
          version: 'latest'

      - name: Install PSScriptAnalyzer
        run: pwsh -Command "Install-Module -Name PSScriptAnalyzer -Scope CurrentUser -Force -SkipPublisherCheck"

      - name: Run PSScriptAnalyzer on start_local_test.ps1
        run: pwsh -Command "Invoke-ScriptAnalyzer -Path ./start_local_test.ps1 -Severity Error; if ($LASTEXITCODE -ne 0) { Write-Error 'PSScriptAnalyzer found issues'; exit 1 }"

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Check Node version
        run: node -v

      - name: Backend: install deps, run tests/build if available, prisma generate
        run: |
          if [ -f services/backend/package.json ]; then
            echo "Backend package.json found"
            cd services/backend
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install --legacy-peer-deps
            fi
            # run tests if test script exists
            node -e "process.exit((require('./package.json').scripts||{}).test ? 0 : 1)" && npm test || echo "no backend test script"
            # run build if build script exists
            node -e "process.exit((require('./package.json').scripts||{}).build ? 0 : 1)" && npm run build || echo "no backend build script"
            # prisma generate if schema exists
            if [ -f prisma/schema.prisma ]; then
              npx prisma generate || true
            fi
          else
            echo "no backend package.json"
          fi

      - name: Mobile app: install deps and start checks
        run: |
          if [ -f mobile-app/package.json ]; then
            echo "Mobile app package.json found"
            cd mobile-app
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install --legacy-peer-deps
            fi
            node -e "process.exit((require('./package.json').scripts||{}).test ? 0 : 1)" && npm test || echo "no mobile-app test script"
          else
            echo "no mobile-app package.json"
          fi

      - name: Security: npm audit (warn only) + upload reports
        run: |
          set -e
          mkdir -p audit-reports
          if [ -f services/backend/package.json ]; then
            echo "Running npm audit for backend (warn-only)"
            cd services/backend
            npm audit --json > "$GITHUB_WORKSPACE/audit-reports/backend-audit.json" || echo "npm audit returned issues (non-failing)"
            cd -
          fi
          if [ -f mobile-app/package.json ]; then
            echo "Running npm audit for mobile-app (warn-only)"
            cd mobile-app
            npm audit --json > "$GITHUB_WORKSPACE/audit-reports/mobile-audit.json" || echo "npm audit returned issues (non-failing)"
            cd -
          fi

      - name: Upload npm audit reports
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-reports
          path: audit-reports/

      - name: Create GitHub issue if critical/high vulnerabilities found
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          found=0
          body="The automated audit detected critical/high vulnerabilities in one or more packages.\n\n"
          for f in audit-reports/*.json; do
            if [ -f "$f" ]; then
              crit=$(jq -r '.metadata.vulnerabilities.critical // 0' "$f")
              high=$(jq -r '.metadata.vulnerabilities.high // 0' "$f")
              if [ "$crit" -gt 0 ] || [ "$high" -gt 0 ]; then
                found=1
                name=$(basename "$f")
                body="$body- $name : critical=$crit, high=$high\n"
              fi
            fi
          done
          if [ "$found" -eq 1 ]; then
            title="Security: Vulnerabilities found by npm audit"
            body="$body\nAction: Please check the full audit reports in the workflow artifacts and address the issues."
            echo "Ensure labels exist: security, automated"
            # create labels if they do not exist (ignore errors if they already exist)
            curl -s -S -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              -d '{"name":"security","color":"b60205","description":"Security issues detected by CI"}' "https://api.github.com/repos/$GITHUB_REPOSITORY/labels" || true
            curl -s -S -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              -d '{"name":"automated","color":"0e8a16","description":"Automated issues created by CI"}' "https://api.github.com/repos/$GITHUB_REPOSITORY/labels" || true
            payload=$(jq -n --arg t "$title" --arg b "$body" --argjson labels '["security","automated"]' --argjson assignees '["Doktor-sys"]' '{title:$t, body:$b, labels:$labels, assignees:$assignees}')
            echo "Creating issue in $GITHUB_REPOSITORY with labels security, automated"
            curl -s -S -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              -d "$payload" "https://api.github.com/repos/$GITHUB_REPOSITORY/issues" > /tmp/issue.json || true
            echo "Issue creation response:"; cat /tmp/issue.json || true
          else
            echo "No critical/high vulnerabilities found."
          fi

      - name: TypeScript: compile check (if tsconfig exists)
        run: |
          if [ -f services/backend/tsconfig.json ]; then
            echo "TypeScript config found in services/backend - running tsc --noEmit"
            cd services/backend
            npx tsc --noEmit || (echo "TypeScript errors in backend"; exit 1)
            cd -
          else
            echo "No tsconfig in services/backend"
          fi
          if [ -f mobile-app/tsconfig.json ]; then
            echo "TypeScript config found in mobile-app - running tsc --noEmit"
            cd mobile-app
            npx tsc --noEmit || (echo "TypeScript errors in mobile-app"; exit 1)
            cd -
          else
            echo "No tsconfig in mobile-app"
          fi
