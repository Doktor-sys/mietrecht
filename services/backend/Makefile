# SmartLaw Backend Makefile
# Vereinfacht Datenbank- und Entwicklungsoperationen

.PHONY: help install dev build test lint clean db-setup db-migrate db-seed db-reset db-studio kms-generate kms-validate

# Default target
help:
	@echo "SmartLaw Backend - VerfÃ¼gbare Befehle:"
	@echo ""
	@echo "  install     - Installiere Dependencies"
	@echo "  dev         - Starte Development Server"
	@echo "  build       - Baue das Projekt"
	@echo "  test        - FÃ¼hre Tests aus"
	@echo "  lint        - FÃ¼hre Linting aus"
	@echo "  clean       - LÃ¶sche Build-Artefakte"
	@echo ""
	@echo "  db-setup    - Erstelle und migriere Datenbank"
	@echo "  db-migrate  - FÃ¼hre Datenbank-Migrationen aus"
	@echo "  db-seed     - FÃ¼lle Datenbank mit Testdaten"
	@echo "  db-reset    - Setze Datenbank zurÃ¼ck und fÃ¼lle mit Testdaten"
	@echo "  db-studio   - Ã–ffne Prisma Studio"
	@echo ""
	@echo "  kms-generate - Generiere KMS Encryption Keys"
	@echo "  kms-validate - Validiere KMS Konfiguration"

# Development
install:
	npm install

dev:
	npm run dev

build:
	npm run build

test:
	npm run test

test-watch:
	npm run test:watch

lint:
	npm run lint

clean:
	rm -rf dist/
	rm -rf node_modules/
	rm -rf coverage/

# Database Operations
db-setup:
	@echo "ğŸ”§ Erstelle Datenbank und fÃ¼hre Migrationen aus..."
	npx prisma migrate dev --name init
	@echo "âœ… Datenbank-Setup abgeschlossen"

db-migrate:
	@echo "ğŸ”„ FÃ¼hre Datenbank-Migrationen aus..."
	npx prisma migrate dev
	@echo "âœ… Migrationen abgeschlossen"

db-generate:
	@echo "ğŸ”§ Generiere Prisma Client..."
	npx prisma generate
	@echo "âœ… Prisma Client generiert"

db-seed:
	@echo "ğŸŒ± FÃ¼lle Datenbank mit Testdaten..."
	npx ts-node prisma/seed.ts
	@echo "âœ… Seeding abgeschlossen"

db-reset:
	@echo "ğŸ”„ Setze Datenbank zurÃ¼ck..."
	npx prisma migrate reset --force
	@echo "ğŸŒ± FÃ¼lle mit Testdaten..."
	npx ts-node prisma/seed.ts
	@echo "âœ… Datenbank-Reset abgeschlossen"

db-studio:
	@echo "ğŸ¨ Ã–ffne Prisma Studio..."
	npx prisma studio

db-deploy:
	@echo "ğŸš€ Deploye Datenbank-Schema..."
	npx prisma migrate deploy
	@echo "âœ… Deployment abgeschlossen"

# Docker Operations
docker-build:
	docker build -t smartlaw-backend .

docker-dev:
	docker-compose -f ../../docker-compose.dev.yml up backend

# Production
start:
	npm start

# Testing
test-unit:
	npm run test -- --testPathPattern="unit"

test-integration:
	npm run test -- --testPathPattern="integration"

test-coverage:
	npm run test -- --coverage

# Linting and Formatting
lint-fix:
	npm run lint -- --fix

format:
	npx prettier --write "src/**/*.{ts,js,json}"

# Health Checks
check-deps:
	npm audit

check-outdated:
	npm outdated

# Environment
env-copy:
	cp .env.example .env
	@echo "ğŸ“ .env Datei erstellt. Bitte konfiguriere die Umgebungsvariablen."

# KMS Operations
kms-generate:
	@echo "ğŸ” Generiere KMS Encryption Keys..."
	node scripts/generate-kms-keys.js
	@echo ""
	@echo "ğŸ’¡ FÃ¼ge die generierten Keys zu deiner .env Datei hinzu"

kms-validate:
	@echo "ğŸ” Validiere KMS Konfiguration..."
	node scripts/validate-kms-config.js

# All-in-one Setup fÃ¼r neue Entwickler
setup: install env-copy db-generate db-setup db-seed
	@echo "ğŸ‰ Setup abgeschlossen!"
	@echo ""
	@echo "âš ï¸  WICHTIG: Generiere KMS Keys mit 'make kms-generate'"
	@echo "           und fÃ¼ge sie zu deiner .env Datei hinzu."
	@echo ""
	@echo "Dann kannst du 'make dev' ausfÃ¼hren."